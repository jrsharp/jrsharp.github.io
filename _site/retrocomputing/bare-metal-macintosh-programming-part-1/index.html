<!doctype html>
<html class="no-js" lang="en">
<head>
		<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Bare-metal Macintosh Programming - Part 1</title>
	<link rel="stylesheet" type="text/css" href="http://172.21.21.114:4000/assets/css/styles_feeling_responsive.css" />
	<script src="http://172.21.21.114:4000/assets/js/modernizr.min.js"></script>
	
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ] 
      }
    });
  </script>

  <noscript>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic|Volkhov' rel='stylesheet' type='text/css' />
  </noscript>
  
  <meta name="google-site-verification" content="Vk0IOJ2jwG_qEoG7fuEXYqv0m2rLa8P778Fi_GrsgEQ" />
	
	<meta name="description" content="" />
	
	

	



	
	<link rel="icon" sizes="32x32" href="http://172.21.21.114:4000/assets/img/favicon-32x32.png" />




	
	<link rel="icon" sizes="192x192" href="http://172.21.21.114:4000/assets/img/touch-icon-192x192.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="180x180" href="http://172.21.21.114:4000/assets/img/apple-touch-icon-180x180-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="http://172.21.21.114:4000/assets/img/apple-touch-icon-152x152-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://172.21.21.114:4000/assets/img/apple-touch-icon-144x144-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="http://172.21.21.114:4000/assets/img/apple-touch-icon-120x120-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://172.21.21.114:4000/assets/img/apple-touch-icon-114x114-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="http://172.21.21.114:4000/assets/img/apple-touch-icon-76x76-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://172.21.21.114:4000/assets/img/apple-touch-icon-72x72-precomposed.png" />




	
	<link rel="apple-touch-icon-precomposed" href="http://172.21.21.114:4000/assets/img/apple-touch-icon-precomposed.png" />	




	
	<meta name="msapplication-TileImage" content="http://172.21.21.114:4000/assets/img/msapplication_tileimage.png" />




	
	<meta name="msapplication-TileColor" content="#fabb00" />



	<!-- Facebook Optimization -->
	<meta property="og:locale" content="en_EN" />
	<meta property="og:type" content="website" />
	<meta property="og:title" content="Bare-metal Macintosh Programming - Part 1" />
	<meta property="og:description" content="Personal website of Jon Sharp - a Seventh-day Adventist Christian, family man, lover of the outdoors, technology leader, enterprise architect, embedded systems engineer, and retrocomputing enthusiast." />
	<meta property="og:url" content="http://172.21.21.114:4000//retrocomputing/bare-metal-macintosh-programming-part-1/" />
	<meta property="og:site_name" content="Jon Sharp, logged on the web" />
	

	

	<!-- Search Engine Optimization -->
	

	<link type="text/plain" rel="author" href="http://172.21.21.114:4000/humans.txt" />

	
</head>
</head>
<body id="top-of-page" class="">
	
	
<div id="navigation" class="sticky">
  <nav class="top-bar" role="navigation" data-topbar>
    <ul class="title-area">
      <li class="name">
      <h1 class="show-for-small-only"><a href="http://172.21.21.114:4000" class="icon-tree"> Jon Sharp, logged on the web</a></h1>
    </li>
       <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
      <li class="toggle-topbar menu-icon"><a href="#"><span>Navigation</span></a></li>
    </ul>
    <section style="z-index: 1000;" class="top-bar-section">

      <ul class="right">
        

              

          
          
        

              

          
          
        

              

          
          
        

              

          
          
        

              

          
          
            
            
              <li class="divider"></li>
              <li><a href="http://172.21.21.114:4000/search/">Search</a></li>

            
            
          
        

              

          
          
            
            
              <li class="divider"></li>
              <li><a href="http://172.21.21.114:4000/contact/">Contact</a></li>

            
            
          
        
        
      </ul>

      <ul class="left">
        

              

          
          

            
            
              <li><a href="http://172.21.21.114:4000/">Home</a></li>
              <li class="divider"></li>

            
            
          
        

              

          
          

            
            

              <li class="has-dropdown">
                <a href="http://172.21.21.114:4000/projects/">Projects</a>

                  <ul class="dropdown">
                    

                      

                      <li><a href="http://172.21.21.114:4000/projects/gameboy/">Gameboy</a></li>
                    

                      

                      <li><a href="http://172.21.21.114:4000/projects/laptops/">Laptop Art</a></li>
                    

                      

                      <li><a href="http://172.21.21.114:4000/projects/vgdev/">Video Game Development</a></li>
                    
                  </ul>
                  
              </li>
              <li class="divider"></li>
            
          
        

              

          
          

            
            

              <li class="has-dropdown">
                <a href="http://172.21.21.114:4000/blog/">Blog</a>

                  <ul class="dropdown">
                    

                      

                      <li><a href="http://172.21.21.114:4000/blog/archive/">Blog Archive</a></li>
                    
                  </ul>
                  
              </li>
              <li class="divider"></li>
            
          
        

              

          
          

            
            

              <li class="has-dropdown">
                <a href="http://172.21.21.114:4000/misc/">Misc</a>

                  <ul class="dropdown">
                    

                      

                      <li><a href="http://172.21.21.114:4000/misc/pinhoti/">Pinhoti Trail</a></li>
                    

                      

                      <li><a href="http://172.21.21.114:4000/misc/sun/">Sun</a></li>
                    

                      

                      <li><a href="http://172.21.21.114:4000/misc/wishlist/">Wishlist</a></li>
                    
                  </ul>
                  
              </li>
              <li class="divider"></li>
            
          
        

              

          
          
        

              

          
          
        
        
      </ul>
    </section>
  </nav>
</div><!-- /#navigation -->

	

	

<div id="masthead-no-image-header">
	<div class="row">
		<div class="small-12 columns">
			<a id="logo" href="http://172.21.21.114:4000" title="Jon Sharp, logged on the web – web log of an Adventist Christian, technology professional, outdoor enthusiast...">
				<img src="http://172.21.21.114:4000/assets/img/JSHeader.png" alt="Jon Sharp, logged on the web – web log of an Adventist Christian, technology professional, outdoor enthusiast...">
			</a>
		</div><!-- /.small-12.columns -->
	</div><!-- /.row -->
</div><!-- /#masthead -->









	<div class="row t30">
	<div class="medium-8 columns medium-offset-2 end">
		<article itemscope itemtype="http://schema.org/Article">
			<header>
				

				<span itemprop="name">
					<p class="subheadline">Booting a Mac Plus without Mac OS</p>
					<h1>Bare-metal Macintosh Programming - Part 1</h1>
				</span>
			</header>


			
			<p class="teaser" itemprop="description">
				
			</p>
			

			<span itemprop="articleSection">
			<p>The original compact Macintoshes (128k, 512k, and Plus) have long been a 
subject of my collection and study, but after acquiring a Canon Cat, I began
to see the Mac in a slightly new light.  The original Macintosh may be a truly
unique blend of hardware and software engineering, but what if you looked at 
the Mac only for its hardware?</p>

<!--more-->

<p>If you know the Mac, you know that it was innovative in large part
because of its ROM.  The Toolbox functions of the ROM really made the Mac
what it was.  As a result, The MacOS (System) software is inextricably linked 
to the ROM code, and the two work together in a clever balance of pointers and 
patched code.  This cleverness and tight engineering allowed the Mac to do a 
lot with its relatively meager resources.</p>

<p>But what if you threw out the ROM and its Toolbox?  The Mac might start to look
not too different from other 68000-based personal computers of its time.<br />
What would you do if someone handed you a Macintosh with no available software? 
What if you were tasked with designing an operating system for this new (rather
limited) 68000-based box?  How would you start?  Would you attempt to emulate 
windowing systems from expensive contemporaries like the Lisa and Alto?  Would 
you take a simpler approach?  Maybe something more like the DOSes of the day?</p>

<p>And what about today?  What features would you include?  Maybe a nice, 
lightweight IP stack? (<a href="http://savannah.nongnu.org/projects/lwip/">lwIP</a>)  How
much could you squeeze into a replacement ROM?  I began to wonder what I could 
get my old Mac to do with the benefit of modern toolchains and open-source 
stacks and kernels.  Relying on all of the available documentation, the 
original Macintosh becomes a blank slate for our imagination.</p>

<p>This first article in my <em>bare-metal Macintosh programming series</em> describes 
my first steps down this road.</p>

<h2 id="a-proof-of-concept-demo">A proof-of-concept demo</h2>

<p>In my search for information on the Macintosh boot process, I ran across 
<a href="https://gist.github.com/kmcallister/3236565ed7eb7b45cf99">this Gist</a> that
outlines a method for booting arbitrary code on a 68k Macintosh – that is,
<em>without</em> Mac OS.  Bingo.  This was the starting point I needed to begin 
exploring my thoughts on alternative software/firmware for the Mac.</p>

<p>I decided my first step was to develop the simplest demo I could think of that would 
show off some of the Mac’s hardware while compact enough to fit into the boot
sector (first 1K) of a floppy.  So I set out to build a simple
bare-metal Macintosh demo written in 68k assembly that displays my own smiling 
face on the machine’s 1-bit framebuffer.</p>

<p>I targeted the Macintosh Plus for the extra RAM and becuase Mini vMac emulates
it by default, but the code should run fine on the 128k/512k as well, now that
I’m using the ROM vector to get the frambuffer start address.  The 68000 of 
these original Macintosh models makes them feel a lot like modern embedded 
systems.  And that’s roughly the approach I’ve taken in thinking of the hardware
 – working with it like a modern, MMU-less ARM microcontroller.</p>

<p>Here’s the result:</p>

<p><img src="http://172.21.21.114:4000/images/HappyJon1.png" alt="Screenshot" /></p>

<p><em>I’m smiling becuase it works ;)</em></p>

<p>(I used <a href="https://www.gimp.org/">The Gimp</a> to create my 1-bit bitmap code block)</p>

<p>And on to <em>how</em> it works…</p>

<h2 id="the-code">The Code</h2>

<p>The code listing follows below. (missing only the full bitmap data)  The
necessary boot block header was borrowed from the 
<a href="http://www.gryphel.com/c/minivmac/">Emile project</a> and is based on the 
Inside Macintosh documentation.</p>

<p>The startup code in the Macintosh ROM eventually loads the first 1024 bytes off
of the disk and this bootblock is then responsible for bootstrapping the OS.
(or other arbitrary code such as our framebuffer demo)</p>

<p>The code itself is rather simple, basic memory copy loops, responsible for
clearing the entire display (white) and copying the bitmap data onto the 
center of the screen.  You may notice that the Mac’s characteristic rounded
corners are of course no longer visible.</p>

<p>At the end is an endless loop, producing a subtle animation effect.</p>

<figure class="highlight"><pre><code class="language-asm" data-lang="asm"># HappyJon Demo
#
# Produced using "68k Mac boot floppy example" template
#
# Boot block header based on first/first.S
# from http://emile.sourceforge.net/
#

# The ROM loads this many bytes from the start of the disk.
.equ stage1_size, 1024

# Define ScrnBase, location in memory containing the start of video memory
.equ ScrnBase, 0x0824

# Macro to define a Pascal string
.macro pString string
pstring_begin_\@:
        .byte   pstring_end_\@ - pstring_string_\@ - 1
pstring_string_\@:
        .string "\string"
pstring_end_\@:
        .fill 16 - (pstring_end_\@ - pstring_begin_\@) , 1, 0
.endm

begin:

ID:          .short  0x4C4B              /* boot blocks signature */
Entry:       bra     start               /* entry point to bootcode */
Version:     .short  0x4418              /* boot blocks version number */
PageFlags:   .short  0x00                /* used internally */
SysName:     pString "Face Demo     "    /* System filename */
ShellName:   pString "Face Demo     "    /* Finder filename */
Dbg1Name:    pString "Face Demo     "    /* debugger filename */
Dbg2Name:    pString "Face Demo     "    /* debugger filename */
ScreenName:  pString "Face Screen   "    /* name of startup screen */
HelloName:   pString "Face          "    /* name of startup program */
ScrapName:   pString "Scrap         "    /* name of system scrap file */
CntFCBs:     .short  10                  /* number of FCBs to allocate */
CntEvts:     .short  20                  /* number of event queue elements */
Heap128K:    .long   0x00004300          /* system heap size on 128K Mac */
Heap256K:    .long   0x00008000          /* used internally */
SysHeapSize: .long   0x00020000          /* system heap size on all machines */

start:
	/* movel	#0x3FA700, %a0 */ /* Start of framebuffer on 4MB Plus */
	movel	(ScrnBase), %a0

	/* clear screen */
	movel	#0x00000000, %d0
	movel	#5472, %d1
clear_loop:
	movel	%d0, (%a0)+
	subi	#1, %d1
	bne	clear_loop

	/* Reset vars for image drawing: */
	lea	buffer, %a1 /* Image data */
	movel	(ScrnBase), %a0
	addal	#7388, %a0 /* Offset to place 64x64 image in center of display */
	movew	#127, %d1
fill_loop:

	movel	(%a1)+, %d0
	movel	%d0, (%a0)+

	/* mod buffer count to find offset and shift memory */
	movel	%d1, %d3
	divuw	#2, %d3
	andil	#0xFFFF0000, %d3
	bne	check_dec

	addal	#56, %a0	/* Move to next line */

check_dec:
	subi	#1, %d1
	bne	fill_loop

	/* One more time! */
	movel	(%a1)+, %d0
	movel	%d0, (%a0)+

	/* Set up an animation / prog indicator: */
	addal	#56, %a0	/* Move to next line */
	movel 	%a0, %a1
	addal	#4, %a1
	movel	#0xFF000000, %d0
	movel	#0x000000FF, %d2

end_loop:
	movel	%d0, (%a0)
	movel	%d2, (%a1)
	rorl	#1, %d0
	roll	#1, %d2
	movel	#10000, %d1
delay_loop:
	nop
	subi	#1, %d1
	bne	delay_loop
	bra	end_loop
end:

buffer:
	dc.l 0b00000000000000000000000000100001
	dc.l 0b11111100000000000000000000000000
	dc.l 0b00000000000000000000000000000011
	dc.l 0b11111100000000000000000000000000
	dc.l 0b00000000000000000000000000111111
	dc.l 0b11111110000000000000000000000000
	dc.l 0b00000000000000000000000001110000
	dc.l 0b01111110000000000000000000000000
	dc.l 0b00000000000000000000000011110111

	...</code></pre></figure>

<h2 id="a-modern-toolchain">A modern toolchain</h2>

<p>Since 68k still lives on, it is an architecture well-supported by GCC, allowing
us to use a familiar toolchain.  I’ve tested several 68k GCC toolchains built
using <a href="http://crosstool-ng.org/">crosstool-ng</a>, across several host platforms. 
(most recently using my venerable <a href="https://getchip.com/">chip</a>)  A quick way
to get started on Windows is to get a pre-built toolchain 
<a href="http://gnutoolchains.com/">here</a>.</p>

<p>A simple Makefile is responsible for producing the binary output that can be
placed directly onto a disk, or booted directly using an accurate Mac emulator
like <a href="http://www.gryphel.com/c/minivmac/">Mini vMac</a>:</p>

<ul>
  <li><code>cd HappyJon</code></li>
  <li><code>make</code></li>
  <li><code>&lt;vMac_path&gt;/Mini\ vMac floppy.img</code></li>
</ul>

<h2 id="clone-build-and-fork">Clone, Build, and Fork</h2>

<p>You can check out the code in my <a href="https://github.com/jrsharp/HappyJon">HappyJon</a>
public repository.  Feel free to clone, build and fork my code.  Try it out on
your own vintage Mac. (instructions for creating a working floppy are in the 
README)  Fire up Mini vMac and see what interesting code you can squeeze into 
the boot block.  </p>

<p>I believe a mirror of the framebuffer memory block is available for 
double-buffering.  It would be fun to see what animations could be created.
Can we start a new Macintosh demoscene? ;)</p>

<h2 id="boot-sector-and-beyond">Boot sector and beyond</h2>

<p>In Part 2, I will go into the next stage of my bare-metal Macintosh efforts,
where I begin to explore something more useful on my sans-MacOS Plus.  To do
anything meaningful I will need to break out of my 1024-byte boot block jail…</p>

			</span>

			
						<div id="page-meta" class="t30">
				<p>
					<!-- Look the author details up from the site config. -->
					
					<!-- Output author details if some exist. -->
					
					<span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name" class="pr20 icon-edit"><a href="http://jonsharp.net/" target="_blank"> Jon Sharp</a></span>
				</span>
				

				
				<time class="icon-calendar pr20" datetime="2016-08-31" itemprop="datePublished"> 2016-08-31</time>
				

				<span class="icon-archive pr20"> RETROCOMPUTING</span>
				<br />
				<span class="pr20"><span class="icon-price-tag pr10"> tech</span> <span class="icon-price-tag pr10"> retrocomputing</span> <span class="icon-price-tag pr10"> mac</span> <span class="icon-price-tag pr10"> macintosh</span> </span>
			</p>

			<div id="post-nav" class="row">
				
				<div class="small-5 columns"><a class="button small radius prev" href="http://172.21.21.114:4000/impressjs-im-impressed/">&laquo; impress.js - I'm impressed.</a></div><!-- /.small-4.columns -->
				
				<div class="small-2 columns text-center"><a class="radius button small" href="http://172.21.21.114:4000/blog/archive/" title="Blog Archive">Archive</a></div><!-- /.small-4.columns -->
				
				<div class="small-5 columns text-right"><a class="button small radius next" href="http://172.21.21.114:4000/embedded/end-of-the-analog-trail/">The End of the Analog Trail &raquo;</a></div><!-- /.small-4.columns -->
				
			</div>
			</div><!--  /.page-meta -->
			

			
		</article>
	</div><!-- /.medium-8.columns -->


	


	
</div><!-- /.row -->


	
	    <div id="up-to-top" class="row">
      <div class="small-12 columns" style="text-align: right;">
        <a class="iconfont" href="#top-of-page">&#xf108;</a>
      </div><!-- /.small-12.columns -->
    </div><!-- /.row -->


    <footer id="footer-content" class="bg-grau">
      <div id="footer">
        <div class="row">
          <div class="medium-6 large-5 columns">
            <h5 class="shadow-black">About This Site</h5>

            <p class="shadow-black">
              Personal website of Jon Sharp - a Seventh-day Adventist Christian, family man, lover of the outdoors, technology leader, enterprise architect, embedded systems engineer, and retrocomputing enthusiast.
              <a href="http://172.21.21.114:4000/info/">More ›</a>
            </p>
          </div><!-- /.large-6.columns -->


          <div class="small-6 medium-3 large-3 large-offset-1 columns">
            
              
                <h5 class="shadow-black">Services</h5>
              
            
              
            
              
            
              
            
              
            
              
              <ul class="no-bullet shadow-black">
              
                
                  <li >
                    <a href=""  title=""></a>
                  </li>
              
                
                  <li >
                    <a href="/contact/"  title="Contact">Contact</a>
                  </li>
              
                
                  <li >
                    <a href="/feed.xml"  title="Subscribe to RSS Feed">RSS</a>
                  </li>
              
                
                  <li >
                    <a href="/atom.xml"  title="Subscribe to Atom Feed">Atom</a>
                  </li>
              
                
                  <li >
                    <a href="/sitemap.xml"  title="Sitemap for Google Webmaster Tools">sitemap.xml</a>
                  </li>
              
              </ul>
          </div><!-- /.large-4.columns -->


          <div class="small-6 medium-3 large-3 columns">
            
              
                <h5 class="shadow-black">Thank you</h5>
              
            
              
            
              
            
              
            
              
            <ul class="no-bullet shadow-black">
            
              
                <li >
                  <a href=""  title=""></a>
                </li>
            
              
                <li class="network-entypo" >
                  <a href="http://entypo.com/" target="_blank"  title="Icons by Daniel Bruce">Icons by Daniel Bruce</a>
                </li>
            
              
                <li class="services-newsletter" >
                  <a href="http://foundation.zurb.com/" target="_blank"  title="Built on Foundation">Built on Foundation</a>
                </li>
            
              
                <li class="sitemap-link" >
                  <a href="http://srobbin.com/jquery-plugins/backstretch/" target="_blank"  title="Using Backstretch by Scott Robbin">Using Backstretch by Scott Robbin</a>
                </li>
            
            </ul>
          </div><!-- /.large-3.columns -->
        </div><!-- /.row -->

      </div><!-- /#footer -->


      <div id="subfooter">
        <nav class="row">
          <section id="subfooter-left" class="b30 small-12 medium-6 columns credits">
            <p>
              Created with &hearts;
              by&nbsp;<a href="http://jonsharp.net/">Jon&nbsp;Sharp</a>
              with&nbsp;<a href="http://jekyllrb.com/" target="_blank">Jekyll</a>
              based&nbsp;on&nbsp;<a href="http://phlow.github.io/feeling-responsive/">Feeling&nbsp;Responsive</a>.
            </p>
          </section>

          <section id="subfooter-right" class="small-12 medium-6 columns social-icons">
            <ul class="inline-list">
            
              <li><a href="http://twitter.com/jrsharp" target="_blank" class="icon-twitter" title="Jon Sharp's Twitter Feed"></a></li>
            
              <li><a href="https://www.linkedin.com/in/jonsharp1" target="_blank" class="icon-linkedin" title="Jon Sharp's LinkedIn Profile"></a></li>
            
              <li><a href="http://github.com/jrsharp" target="_blank" class="icon-github" title="Jon Sharp's GitHub"></a></li>
            
            </ul>
          </section>
        </nav>
      </div><!-- /#subfooter -->
    </footer>

	

	<script src="http://172.21.21.114:4000/assets/js/javascript.min.js"></script>





<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-70305955-1', 'auto');
  ga('send', 'pageview');

</script>






</body>
</html>

